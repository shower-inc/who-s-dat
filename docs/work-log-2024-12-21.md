# 作業ログ 2024-12-21

## 概要
WHO'S DAT (JUSMINE v2) - 海外音楽ニュース自動投稿システムの機能改善・バグ修正

---

## 1. 記事削除後の再取得問題を修正

### 問題
- 削除した記事を再取得しても「新規0件」となり、記事管理に表示されない

### 原因
1. `article_tags`テーブルの外部キー制約により記事削除がブロックされていた
2. `.single()`メソッドが結果なしの場合にエラーを投げていた

### 修正内容
- `src/app/api/articles/[id]/route.ts`: DELETE時に`article_tags`を先に削除
- `src/app/api/sources/[id]/fetch/route.ts`: `.single()`を`.maybeSingle()`に変更

---

## 2. X投稿文再生成機能を追加

### 問題
- X投稿文が既に存在すると「生成」ボタンが表示されなくなっていた

### 修正内容
- `src/app/admin/articles/article-list.tsx`:
  - `canRegenerate`条件を追加
  - 「X投稿文を再生成」ボタンを追加（xPostが存在する場合に表示）

---

## 3. ソースサムネイル表示機能を追加

### 問題
- ソース管理画面でYouTubeチャンネルのサムネイルが表示されていなかった

### 修正内容
- `src/types/database.ts`: `sources`テーブルに`thumbnail_url`フィールド追加
- `src/app/admin/sources/source-list.tsx`: サムネイル表示UI追加
- `src/app/admin/sources/new/page.tsx`: 新規ソース追加時にサムネイルURLを保存
- 既存ソースのサムネイルを一括更新するスクリプトを実行

---

## 4. 管理画面のデータ取得問題を修正

### 問題
- 記事管理画面に記事が表示されない（DBには104件あるのに0件表示）

### 原因
1. `createServerClient`（SSR用）ではサービスロールキーが正しく機能しない
2. RLSポリシーによりデータがブロックされていた

### 修正内容
- `src/lib/supabase/server.ts`: `createServiceClient`を`@supabase/supabase-js`の`createClient`を使用するように変更
- 管理画面の全ページに`export const dynamic = 'force-dynamic'`を追加（キャッシュ無効化）

---

## 5. タグ機能を有効化

### 問題
- `tags`と`article_tags`テーブルがDBに存在しなかった
- クエリエラー: "Could not find a relationship between 'articles' and 'article_tags'"

### 修正内容
- Supabase SQL Editorで`tags`と`article_tags`テーブルを作成
- `supabase/migrations/003_create_tags.sql`を作成
- `src/app/admin/articles/page.tsx`: クエリに`article_tags`を追加

---

## 6. X API認証情報を更新

### 問題
- X投稿時に「You are not permitted to perform this action」エラー

### 原因
- App permissionsが「Read」のみだった（「Read and Write」が必要）

### 対応
- X Developer Portalでpermissionsを「Read and Write」に変更
- Access Token & Secretを再生成
- API Key & Secretを再生成
- `.env.local`とVercel環境変数を更新

### 現在の状態
- 認証は成功
- レートリミット（Too Many Requests）により一時的に投稿制限中
- 15分後に再試行可能

---

## 変更ファイル一覧

```
src/app/admin/articles/article-list.tsx  - X再生成ボタン追加
src/app/admin/articles/page.tsx          - ServiceClient使用、タグクエリ追加
src/app/admin/dashboard/page.tsx         - ServiceClient使用、force-dynamic追加
src/app/admin/posts/page.tsx             - ServiceClient使用、force-dynamic追加
src/app/admin/sources/page.tsx           - ServiceClient使用、force-dynamic追加
src/app/admin/sources/source-list.tsx    - サムネイル表示追加
src/app/admin/sources/new/page.tsx       - サムネイルURL保存追加
src/app/api/articles/[id]/route.ts       - article_tags削除処理追加
src/app/api/sources/[id]/fetch/route.ts  - maybeSingle使用
src/lib/supabase/server.ts               - createServiceClient修正
src/types/database.ts                    - thumbnail_url, tags, article_tags型追加
supabase/migrations/003_create_tags.sql  - タグテーブル作成SQL
.env.local                               - X API認証情報更新
```

---

## 次のタスク（保留）
- X投稿レートリミット解除後に投稿テスト
- 確認フロー機能の検討（生成内容の確認ステップ追加）

# 作業ログ 2024-12-22

## 概要
記事クオリティ改善、LLMをGeminiに切り替え、ソース管理画面リニューアル、記事編集機能強化

---

## 1. 記事クオリティ改善

### 問題
- 生成される記事のクオリティが低い
- NGワード（「注目を集めている」「必聴」等）が出力される
- 情報が薄い

### 対策（4つ実施）

#### 1.1 Gemini検索で追加情報を取得
**ファイル:** `src/lib/web/gemini-search.ts`
- `enrichArticleInfo()` 関数を追加
- アーティストの背景情報、曲の文脈、関連ニュース、シーンでの位置づけを検索
- `formatEnrichedInfo()` でプロンプト用テキストに整形

#### 1.2 関連記事機能
**ファイル:** `src/lib/articles/related.ts`（新規作成）
- `findRelatedArticles()`: 同じアーティストの過去記事を検索
- `formatRelatedArticles()`: プロンプト用テキストに整形

#### 1.3 複数情報の統合
**ファイル:** `src/app/api/articles/[id]/process/route.ts`
- アーティスト情報 + Gemini検索結果 + 関連記事を結合してLLMに渡す

#### 1.4 プロンプト改善
**ファイル:** `src/lib/llm/prompts.ts`
- カジュアルな友達に共有するトーンに変更
- NGワードを明示（「注目を集めている」「必聴」「唯一無二」等）
- 良い例・悪い例を追加
- HTML形式で出力指示

---

## 2. LLMをGemini Flashに切り替え

### 理由
- Claude Haikuだとプロンプトの指示に従わないことがある
- Gemini Flashは無料枠大きい、品質もそこそこ

### 変更内容
**ファイル:** `src/lib/llm/gemini-client.ts`（新規作成）
- `translateTextWithGemini()`: タイトル翻訳
- `generateArticleWithGemini()`: 記事生成
- `generatePostWithGemini()`: X投稿文生成
- `generateTrackArticleWithGemini()`: トラック紹介記事

**ファイル:** `src/app/api/articles/[id]/process/route.ts`
- `generateArticle` → `generateArticleWithGemini`
- `generatePost` → `generatePostWithGemini`

### 環境変数
- `GEMINI_API_KEY` をVercelに追加

---

## 3. 自動フェッチ停止

**ファイル:** `.github/workflows/cron.yml`
- scheduleをコメントアウト
- `workflow_dispatch`（手動実行）のみ有効

---

## 4. ソース管理画面リニューアル

### 新しい流れ
1. ソース管理画面で「最新を取得」
2. プレビューモーダルが開く
3. 記事を選択（新規のみ選択可、既存は「追加済み」表示）
4. 「○件を記事に追加」で記事管理に追加

### 新規API
**ファイル:** `src/app/api/sources/[id]/preview/route.ts`
- フィードを取得してプレビュー（DBには保存しない）
- 既存記事との重複チェック

**ファイル:** `src/app/api/sources/[id]/import/route.ts`
- 選択した記事をDBに追加

### UI更新
**ファイル:** `src/app/admin/sources/source-list.tsx`
- プレビューモーダル追加
- 記事選択UI（チェックボックス）
- 全選択/全解除ボタン

### サイドバー追加
**ファイル:** `src/components/layout/sidebar.tsx`
- 「📡 ソース管理」を追加

---

## 5. 記事編集で公開日時を編集可能に

### 問題
- `published_at`がnullの記事がサイトで最上位に表示される

### 対策
**ファイル:** `src/app/admin/articles/article-list.tsx`
- 記事編集モーダルに「公開日時」フィールドを追加
- `datetime-local`で日時を選択可能

**ファイル:** `src/app/api/articles/[id]/route.ts`
- `published_at`と`editor_note`を更新可能に

---

## 変更ファイル一覧

### 新規作成
- `src/lib/llm/gemini-client.ts` - Gemini API クライアント
- `src/lib/articles/related.ts` - 関連記事検索
- `src/app/api/sources/[id]/preview/route.ts` - プレビューAPI
- `src/app/api/sources/[id]/import/route.ts` - インポートAPI

### 更新
- `src/lib/web/gemini-search.ts` - enrichArticleInfo追加
- `src/lib/llm/prompts.ts` - プロンプト改善
- `src/app/api/articles/[id]/process/route.ts` - Gemini使用、情報統合
- `src/app/api/articles/[id]/route.ts` - published_at, editor_note対応
- `src/app/admin/sources/source-list.tsx` - プレビューモーダル
- `src/app/admin/articles/article-list.tsx` - 公開日時編集
- `src/components/layout/sidebar.tsx` - ソース管理追加
- `.github/workflows/cron.yml` - 自動フェッチ停止

---

## 6. カスタムドメイン設定（whosdat.jp）

### 問題
- Vercelにドメインは追加済みだが「Invalid Configuration」
- DNSが反映されない

### 原因
- お名前.comでDNS設定ができていなかった

### 対策
**お名前.com Navi でDNSレコード追加:**

| TYPE | ホスト名 | VALUE | TTL |
|------|----------|-------|-----|
| A | whosdat.jp | 76.76.21.21 | 3600 |
| CNAME | whosdat.whosdat.jp | cname.vercel-dns.com | 3600 |

### 結果
- DNS反映完了
- https://whosdat.jp でアクセス可能に
- SSL証明書はVercelが自動発行（数分で反映）

---

## コミット履歴

1. `feat: 記事品質大幅改善` - Gemini検索、関連記事、プロンプト改善
2. `chore: 自動フェッチを停止（手動実行のみ）`
3. `feat: 記事生成をGemini Flashに切り替え`
4. `feat: ソース管理画面リニューアル`
5. `fix: サイドバーにソース管理を追加`
6. `feat: 記事編集で公開日時を編集可能に`
7. `docs: 作業ログ 2024-12-22` - カスタムドメイン設定追加
